<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <title>Tethys</title>
  <style>
    html,
    body {
      height: 100%;
      width: 100%;
    }

    #title {
      color: white;
    }

    #treeStructureBox {
      margin: auto;
      width: 99%;
      height: 70%;
      margin-bottom: 10px;
    }

    #queryRefinerBox {
      margin: auto;
      width: 99%;
      height: 18%;
    }

    iframe {
      border: none;
      width: 100%;
      height: 90%;
    }

    svg {
      border: 1px solid silver;
    }

    .node {
      cursor: pointer;
    }

    .node circle {
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .link {
      fill: none;
      stroke: lightgray;
      stroke-width: 1.5px;
    }

    #treeStructureBox {
      font-size: 10px;
    }

  </style>
</head>

<body>
  <!--     Main Navbar-->
  <nav class="navbar navbar-dark bg-primary justify-content-between">
    <a id="title" class="navbar-brand">Hello I'm Tethys</a>
  </nav>

  <!--Second Small navbar Page.(Schema tree structure)(show all collapse all search)   -->
  <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div class="dropdown">
      <select id="schemaSelector" class="btn btn-info btn-outline-primary btn-sm custom-select">
        <option value="0">Select a Schema</option>
        <option value="1">Calibrations</option>
        <option value="2">Deployment</option>
        <option value="3">Detections.v1_2</option>
        <option value="4">Detections</option>
        <option value="5">Ensemble</option>
        <option value="6">Events</option>
        <option value="7">Itis</option>
        <option value="8">Localization</option>
        <option value="9">New Deployment</option>
        <option value="10">Species Abbreviations</option>
        <option value="11">Tethys</option>
        <option value="12">Tethys Schema Project</option>
        <option value="13">Transfer Function</option>
      </select>
    </div>

    <!--    form-->

    <div class="">


      <form class="form-inline justify-content-end">
        <button type="button" class="mr-sm-1 btn btn-sm btn-dark">Show All</button>
        <button type="button" class="mr-sm-1 btn btn-sm btn-dark">Collapse All</button>
        <input class="form-control btn-sm mr-sm-1" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-sm btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </nav>


  <!--  Space for the Tree structure -->

  <div id="treeStructureBox" class="border border-primary">
    <h3>Please Select a Schema</h3>
  </div>

  <!-- Space for the query refiner   -->
  <div id="queryRefinerBox" class="border border-primary">
    <h3>I'm a Query Refiner</h3>
  </div>

  <div id="info">
    <h1>his</h1>
  </div>


  <script>
    $(document).ready(function() {
      console.log("Im Jquery and Im working");


      //onChange of schena selecter update the tree
      //??????????????????????????????????????????????????????????????
      $('#schemaSelector').on('change', function() {
        var selectedVal = $(this).val();
        if (selectedVal == 0) {
          $('#treeStructureBox').html("<h3>Please Select a Schema</h3>");
          console.log("0");
        } else if (selectedVal == 1) {
          $('#treeStructureBox').html("");
          console.log("1");
          something("1");
        } else if (selectedVal == 2) {
          $('#treeStructureBox').html("");
          console.log("2");
          something("2");
        } else if (selectedVal == 3) {
          $('#treeStructureBox').html("");
          console.log("3");
          something("3");
        } else {
          $('#treeStructureBox').html("");
          console.log("You hit the else statements");
          $('#treeStructureBox').html("<h3>Else statement</h3>");
        }

        //??????????????????????????????????????????????????????????????



      });


      //D3 begins
      function something(Value) {
        var json1 = {
          "name": "ShipOrder",
          "children": [{
              "name": "Orderperson",
              "type": "xs:string",
            },
            {
              "name": "Shipto",
              "children": [{
                "name": "name",
                "type": "xs:string"
              }, {
                "name": "Shipto",
                "children": [{
                  "name": "name",
                  "type": "xs:string"
                }, {
                  "name": "Shipto",
                  "children": [{
                    "name": "name",
                    "type": "xs:string"
                  }, {
                    "name": "address",
                    "type": "xs:string"
                  }, {
                    "name": "city",
                    "type": "xs:string"
                  }, {
                    "name": "Shipto",
                    "children": [{
                      "name": "name",
                      "type": "xs:string"
                    }, {
                      "name": "address",
                      "type": "xs:string"
                    }, {
                      "name": "city",
                      "type": "xs:string"
                    }, {
                      "name": "country",
                      "type": "xs:string"
                    }, ]
                  }, {
                    "name": "country",
                    "type": "xs:string"
                  }, ]
                }, {
                  "name": "address",
                  "type": "xs:string"
                }, {
                  "name": "city",
                  "type": "xs:string"
                }, {
                  "name": "country",
                  "type": "xs:string"
                }, ]
              }, {
                "name": "address",
                "type": "xs:string"
              }, {
                "name": "city",
                "type": "xs:string"
              }, {
                "name": "country",
                "type": "xs:string"
              }, ]
            },
            {
              "name": "item",
              "children": [{
                "name": "title",
                "type": "xs:string"
              }, {
                "name": "note",
                "type": "xs:string"
              }, {
                "name": "quanityt",
                "type": "xs:positiveInteger"
              }, {
                "name": "price",
                "type": "xs:decimal"
              }, ]
            },
            {
              "name": "orderid",
              "type": "xs:string"
            }
          ]
        };
        var deployment = {
          "name": "Deployment",
          "children": [{
            "name": "Common Elements",
            "children": [{
              "name": "Description Type",
              "comment": "Text based description of process",
              "children": [{
                "name": "Sequence",
                "children": [{
                  "name": "Objectives",
                  "type": "string",
                  "comment": "What are the objectives of this effort?  Examples: Beamform to increase SNR for detection. Detect every click of a rare species. Verify data quality."
                }, {
                  "name": "Abstract",
                  "type": "string",
                  "comment": "Overview of effort"
                }, {
                  "name": "Method",
                  "type": "string",
                  "comment": "High-level description of the method used"
                }]
              }]

            }, {
              "name": "Data Source Type",
              "comment": "Indicates the deployment or ensemble from which the process (e.g detector) derived information",
              "children": [{
                "name": "choice",
                "children": [{
                  "name": "Ensemble Name",
                  "comment": "Name of a group of instruments being used together for a common purpose (e.g. large aperture array).  The Name will correspond to an instance in the Ensemble collection.",
                  type: "string"
                }, {
                  "name": "Sequence",
                  comment: "Information that identifies a specific deployment within the Deployment collection.",
                  "children": [{
                    "name": "Project",
                    "type": "string"
                  }, {
                    "name": "Deployment",
                    "type": "integer"
                  }, {
                    "name": "Choice",
                    "children": [{
                      "name": "Site",
                      "type": "string"
                    }, {
                      "name": "Cruise",
                      "type": "string"
                    }]
                  }]
                }]
              }, ]
            }, {
              "name": "Algorithm Type",
              "comment": "Description of detection algorithm",
              "children": [{
                "name": "Method",
                "comment": "Text based description of algorithm or citation",
                "type": "string"

              }]
            }]
          }, {
            "name": "Deployment",
          }, {
            "name": "Generic Sensor",
          }, {
            "name": "Unknown Sensor",
          }, {
            "name": "Audio",
          }, {
            "name": "Channel Info",
          }, {
            "name": "Deployment Recovery Details"
          }, {
            "name": "Accoustic Data QA Type"
          }, {
            "name": "Path Element Type"
          }]
        };






        var json3 = {
          "name": "3ShipOrder",
          "children": [{
              "name": "3Orderperson",
              "type": "3xs:string",
            },
            {
              "name": "333Shipto",
              "children": [{
                "name": "name",
                "type": "xs:string"
              }, {
                "name": "address",
                "type": "xs:string"
              }, {
                "name": "city",
                "type": "xs:string"
              }, {
                "name": "country",
                "type": "xs:string"
              }, ]
            },
            {
              "name": "item",
              "children": [{
                "name": "title",
                "type": "xs:string"
              }, {
                "name": "note",
                "type": "xs:string"
              }, {
                "name": "quanityt",
                "type": "xs:positiveInteger"
              }, {
                "name": "price",
                "type": "xs:decimal"
              }, ]
            },
            {
              "name": "orderid",
              "type": "xs:string"
            }
          ]
        };

        var width = 700;
        var height = 650;
        var maxLabel = 150;
        var duration = 500;
        var radius = 5;

        var i = 0;
        var root;

        var tree = d3.layout.tree().size([height, width]);

        var diagonal = d3.svg.diagonal().projection(function(d) {
            return [d.y, d.x];
          }

        );

        var svg = d3.select("#treeStructureBox").append("svg").attr("width", "100%").attr("height", "100%").append("g").attr("transform", "translate(" + maxLabel + ",0)");

        //??????????????????????????????????????????????????????????????
        if (Value == 1) {
          root = json1;
        } else if (Value == 2) {
          root = deployment;
        } else if (Value == 3) {
          root = json3;
        } else if (Value == 4) {
          root = json4;
        } else if (Value == 5) {
          root = json5;
        } else if (Value == 6) {
          root = json6;
        } else if (Value == 7) {
          root = json7;
        }

        //??????????????????????????????????????????????????????????????

        root.x0 = height / 2;
        root.y0 = 0;

        root.children.forEach(collapse);

        function update(source) {
          // Compute the new tree layout.
          var nodes = tree.nodes(root).reverse();
          var links = tree.links(nodes); // Normalize for fixed-depth.
          nodes.forEach(function(d) {
            d.y = d.depth * maxLabel;
          }); // Update the nodes…
          var node = svg.selectAll("g.node").data(nodes, function(d) {
            return d.id || (d.id = ++i);
          }); // Enter any new nodes at the parent's previous position.
          var nodeEnter = node.enter().append("g").attr("class", "node").attr("transform", function(d) {
            return "translate(" + source.y0 + "," + source.x0 + ")";
          }).on("click", click);

          nodeEnter.append("circle").attr("r", 0).style("fill", function(d) {
            return d._children ? "lightsteelblue" : "white";
          });

          nodeEnter.append("text").attr("x", function(d) {
            var spacing = computeRadius(d) + 5;
            return d.children || d._children ? -spacing : spacing;
          }).attr("dy", "3").attr("text-anchor", function(d) {
            return d.children || d._children ? "end" : "start";
          }).text(function(d) {
            //if (d.type && d.comment) return d.name + " : " + d.type + " : " + d.comment;
            if (d.type) return d.name + " : " + d.type;
            //else if (d.comment) return d.name + " : " + d.comment;
            else return d.name;
          }).style("fill-opacity", 0); // Transition nodes to their new position.
          var nodeUpdate = node.transition().duration(duration).attr("transform", function(d) {
            return "translate(" + d.y + "," + d.x + ")";
          });

          nodeUpdate.select("circle").attr("r", function(d) {
            return computeRadius(d);
          }).style("fill", function(d) {
            return d._children ? "lightsteelblue" : "#fff";
          });

          nodeUpdate.select("text").style("fill-opacity", 1); // Transition exiting nodes to the parent's new position.
          var nodeExit = node.exit().transition().duration(duration).attr("transform", function(d) {
            return "translate(" + source.y + "," + source.x + ")";
          }).remove();

          nodeExit.select("circle").attr("r", 0);
          nodeExit.select("text").style("fill-opacity", 0); // Update the links…
          var link = svg.selectAll("path.link").data(links, function(d) {
            return d.target.id;
          }); // Enter any new links at the parent's previous position.
          link.enter().insert("path", "g").attr("class", "link").attr("d", function(d) {
            var o = {
              x: source.x0,
              y: source.y0
            };
            return diagonal({
              source: o,
              target: o
            });
          }); // Transition links to their new position.
          link.transition().duration(duration).attr("d", diagonal); // Transition exiting nodes to the parent's new position.
          link.exit().transition().duration(duration).attr("d", function(d) {
            var o = {
              x: source.x,
              y: source.y
            };
            return diagonal({
              source: o,
              target: o
            });
          }).remove(); // Stash the old positions for transition.
          nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
          });
        }

        function computeRadius(d) {
          if (d.children || d._children) return radius + (radius * nbEndNodes(d) / 10);
          else return radius;
        }

        function nbEndNodes(n) {
          nb = 0;
          if (n.children) {
            n.children.forEach(function(c) {
              nb += nbEndNodes(c);
            });
          } else if (n._children) {
            n._children.forEach(function(c) {
              nb += nbEndNodes(c);
            });
          } else nb++;

          return nb;
        }

        function click(d) {
          if (d.children) {
            d._children = d.children;
            d.children = null;
          } else {
            d.children = d._children;
            d._children = null;
          }
          update(d);
        }

        function collapse(d) {
          if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
          }
        }
        update(root);
      }

      //D3 ends

    }); //document.Ready




    //        var url = "http://localhost:9779/XQuery";
    //        var dataKey = 'XQuery';
    //        var dataValue = `(: import Tethys schema so we have type information about the docuements :)
    //import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
    //(: import utility functions :)
    //import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";
    //
    //
    //let $xmldocument := 0  (: first document :)
    //let $xmldocs := ()     (: no documents so far :)
    //
    //(: Find all of the desired detections.  
    //   This query is a bit more complicated than it need by as we are tracking
    //   which XML document the detections came from.  
    //
    //   This is sometimes useful, especially when there are multiple lines
    //   of effort across the same time and space, although it is not really 
    //   needed here.
    //
    //   We create a temporary variable with all of the detections and then sort them
    //   in the next query.  Again, this is overengineering for this specific query,
    //   but would be needed to return detections from multiple deployments in order.
    //:)
    //let $detections := for $item in (
    //    for $det at $p in collection("Detections")/ty:Detections
    //        let $xmldocument := $xmldocument + 1
    //        let $xmldocs := ($xmldocs, $det/DataSource)
    //        (: conditions on Detections group :)
    //        where upper-case($det/DataSource/Site) = upper-case("M") and 
    //              upper-case($det/DataSource/Project) = upper-case("SOCAL") and
    //              $det/DataSource/Deployment = 38.000000 
    //        return
    //           for $detection in $det/OnEffort/Detection  (: OnEffort/OffEffort :)
    //              (: conditions on individual Detections, here we use
    //                 an abbreviation for the species name  :)
    //              where $detection/SpeciesID = lib:abbrev2tsn("Zc", "NOAA.NMFS.v1") 
    //           return
    //                <Detection>
    //                  {$detection/Start}
    //                  {$detection/End}
    //                  <idx>{xs:integer($p)}</idx>
    //                </Detection>
    //        )
    //  return $item
    //
    //(: Sources contains the list of indices corresponding to all of the documents
    //   from which we drew detections :)
    //let $sources := distinct-values(for $d in $detections return $d/idx)
    //
    //(: Finally, we return the detections and a lsit of the data sources
    //   from which they came. :)
    //
    //return
    //<ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    //<Detections>
    //  {(: Rewrite the detections mapping each detection to a deployment/ensemble :)
    //   for $d in $detections
    //   order by $d/Start
    //   return
    //     <Detection>
    //      {$d/Start}
    //      {$d/End}
    //      <idx>{index-of(($sources), $d/idx)}</idx>
    //     </Detection>
    //  }
    //</Detections>
    //<Sources>
    //  {
    //   (: Write out the information for the deployment/ensembles :)
    //   for $source in $sources
    //     return
    //      collection("Detections")[xs:decimal($source)]/ty:Detections/DataSource
    //  }
    //</Sources>
    //</ty:Result>`;
    //
    //
    //
    //
    //        var data = {"XQuery":dataValue};
    //        $.post(url, data, function(data){
    //            console.log(data);
    //          $('#info').html(data);  
    //        })

  </script>


</body>

</html>
