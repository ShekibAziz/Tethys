<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tethys</title>
	<!--  JQuery 3-->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<!-- bootstrap 4 CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
	<!--  Pooper for bootstrap-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
	<!-- bootstrap 4 JS -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	<!--D3js.org for data visualization  -->
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<!--Select 2 JS-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.js"></script>
	<!-- Select 2 CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.css" rel="stylesheet" />
	<!-- Style CSS -->
	<link rel="stylesheet" href="../css/style.css">
	<!-- custom style that only applies to this page-->
	<style>
		body {
			overflow: hidden;
		}

		.card {
			margin-top: 3px;
			width: 100%;
		}

		#cannedQueries {
			padding-left: 0px;
		}

		/* The side navigation menu */

		.sidenav {
			height: 100%;
			/* 100% Full-height */
			width: 0;
			/* 0 width - change this with JavaScript */
			position: fixed;
			/* Stay in place */
			z-index: 1;
			/* Stay on top */
			top: 0;
			left: 0;
			background-color: #a6d8ff;
			/* Black*/
			overflow-x: hidden;
			/* Disable horizontal scroll */
			padding-top: 60px;
			/* Place content 60px from the top */
			transition: 0.35s;
			/* 0.5 second transition effect to slide in the sidenav */
		}

		/* The navigation menu links */

		.sidenav a {
			padding: 8px 8px 8px 32px;
			text-decoration: none;
			font-size: 16px;
			color: rgba(26, 26, 26, 0.81);
			display: block;
			transition: 0.3s;
		}

		/* When you mouse over the navigation links, change their color */

		.sidenav a:hover {
			color: #111;
		}

		/* Position and style the close button (top right corner) */

		.sidenav .closebtn {
			position: absolute;
			top: 0;
			right: 25px;
			font-size: 36px;
			margin-left: 50px;
		}

		/* Style page content - use this if you want to push the page content to the right when you open the side navigation */

		#main {
			transition: margin-left .5s;
			padding: 10px;
			margin: 0px 5px;
		}

		/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */

		@media screen and (max-height: 450px) {
			.sidenav {
				padding-top: 15px;
			}
			.sidenav a {
				font-size: 18px;
			}
		}

		#editor {}

	</style>
</head>

<body>

	<!--     Main Navbar-->
	<nav class="navbar-expand navbar navbar-light" style="background-color: #e3f2fd;">
		<a class="navbar-brand" href="../index.html">Tethys</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
		<div class="collapse navbar-collapse" id="navbarNavDropdown">
			<ul class="ml-auto navbar-nav">
				<li class="nav-item active">
					<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Queries
        </a>
					<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
						<a class="dropdown-item" href="cannedQueries.html">Canqueries</a>
						<a class="dropdown-item" href="advancedqueries.html">Advansed Queries</a>
					</div>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">FAQ</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Manual</a>
				</li>

			</ul>
		</div>
	</nav>
	<!--   //  Main Navbar-->



	<!-- Add all page content inside this div if you want the side nav to push page content to the right (not used if you only want the sidenav to sit on top of the page -->



	<div class="row" id="main">
		<div class="col-4" id=cannedQueries>

			<div class="card">
				<div class="text-center card-header">
					<div id="mySidenav" class="sidenav">
						<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
						<a href="#">Deployment Query</a>
						<a href="#">Detections Query</a>
						<a href="#">Localization Query</a>
						<a href="#">Detections Query</a>
						<a href="#">Awesome Query</a>
					</div>

					<!-- Use any element to open the sidenav -->
					<span class="sideBarPopUp" onclick="openNav()"><button class="navbar-toggler pull-xs-right" id="navbarSideButton" type="button">
      &#9776;
    </button></span> Canned Query Sample
				</div>
				<div class="card-body">
					<form>
						<div class="form-group">
							<label for="project">Project</label>
							<select class="form-control" id="project">
                <option>---</option>
                <option>SOCAL</option>
                <option>ALEUT</option>
                <option>CINMS</option>
              </select>
						</div>
						<div class="form-group">
							<label for="site">Site: </label>
							<input type="text" class="form-control" id="site" placeholder="Site name">
						</div>
						<div class="form-group">
							<label for="cruise">Cruise: </label>
							<input type="text" class="form-control" id="cruise" placeholder="Cruise name">
						</div>

						<button type="submit" id="submit" class="btn btn-primary">Submit</button>
					</form>


				</div>
			</div>

		</div>

		<div class="col-8" id="response"></div>
	</div>










	<!--editor-->
	<script src="../ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="../ace-builds\src-noconflict\ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
	<!--Custom script to this page (cannedQueries.html)-->
	<script>
		$(document).ready(function() {


			/*EDITOR*/

			var initialText = "Please select the query you wish to run \nChoose any additional attributes and then click Submit"; //initial value

			var editor = ace.edit("response");
			editor.setTheme("ace/theme/cobalt");
			editor.session.setMode("ace/mode/xml");
			editor.setOptions({
				enableBasicAutocompletion: true,
				enableSnippets: true,
				enableLiveAutocompletion: true
			});
			editor.setValue(initialText, 1); //set initial value

			/*LIVE PREVIEW*/

			editor.session.on('change', function(delta) {
				// delta.start, delta.end, delta.lines, delta.action
				var input = editor.getValue();
				$("#preview").prop("srcdoc", input);
			});




			var url = "http://localhost:9779/XQuery";
			var dataKey = 'XQuery';
			var dataValue = `
      (: import Tethys schema so we have type information about the docuements :) 
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd"; 
      (: import utility functions :)
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq"; let $xmldocument := 0 (: first document :) let $xmldocs := () (: no documents so far :) (: Find all of the desired detections. This query is a bit more complicated than it need by as we are tracking which XML document the detections came from. This is sometimes useful, especially when there are multiple lines of effort across the same time and space, although it is not really needed here. We create a temporary variable with all of the detections and then sort them in the next query. Again, this is overengineering for this specific query, but would be needed to return detections from multiple deployments in order. :) let $detections := for $item in ( for $det at $p in collection("Detections")/ty:Detections let $xmldocument := $xmldocument + 1 let $xmldocs := ($xmldocs, $det/DataSource) (: conditions on Detections group :) where upper-case($det/DataSource/Site) = upper-case("M") and upper-case($det/DataSource/Project) = upper-case("SOCAL") and $det/DataSource/Deployment = 38.000000 return for $detection in $det/OnEffort/Detection (: OnEffort/OffEffort :) (: conditions on individual Detections, here we use an abbreviation for the species name :) where $detection/SpeciesID = lib:abbrev2tsn("Zc", "NOAA.NMFS.v1") return
      <Detection>
        {$detection/Start} {$detection/End}
        <idx>{xs:integer($p)}</idx>
      </Detection>
      ) return $item (: Sources contains the list of indices corresponding to all of the documents from which we drew detections :) let $sources := distinct-values(for $d in $detections return $d/idx) (: Finally, we return the detections and a lsit of the data sources from which they came. :) return
      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <Detections>
          {(: Rewrite the detections mapping each detection to a deployment/ensemble :) for $d in $detections order by $d/Start return
          <Detection>
            {$d/Start} {$d/End}
            <idx>{index-of(($sources), $d/idx)}</idx>
          </Detection>
          }
        </Detections>
        <Sources>
          { (: Write out the information for the deployment/ensembles :) for $source in $sources return collection("Detections")[xs:decimal($source)]/ty:Detections/DataSource }
        </Sources>
      </ty:Result>`;

			var dataValue2 = `
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";

      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      {
      for $deployment in collection("Deployments")/ty:Deployment 
      where $deployment/Project = "SOCAL"

      return data($deployment/Project)

      }
      </ty:Result>
    `;

			var DataValue3 = `
      import schema namespace ty='http://tethys.sdsu.edu/schema/1.0' at 'tethys.xsd';
      import module namespace lib='http://tethys.sdsu.edu/XQueryFns' at 'Tethys.xq';

      collection("SpeciesAbbreviations")/ty:Abbreviations/Name
    `;

			//Projects
			var DataValue4 = `
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";
      
      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      {
      for $deployment in collection("Deployments")/ty:Deployment
        return data($deployment/Project)
      }
      </ty:Result>
    `;

			// Lat-long per project
			var DataValue5 = `
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";
      
      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      {
      for $deployment in collection("Deployments")/ty:Deployment
        where $deployment/Project = "SOCAL"
        return <li>{data($deployment/RecoveryDetails/Longitude)},{data($deployment/RecoveryDetails/Latitude)}</li>
      }
      </ty:Result>
    `;

			//Deployment with basic information
			var basicQuery = ` 
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";
    
      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      {
      for $deployment in collection("Deployments")/ty:Deployment
        where $deployment/Project = "SOCAL"
        return <li>
      {data($deployment/Site)},{data($deployment/Cruise)},{data($deployment/Platform)},{data($deployment/Instrument/Type)},{data($deployment/SamplingDetails/Channel/Start)},{data($deployment/RecoveryDetails/Longitude)},{data($deployment/RecoveryDetails/Latitude)}</li>
      }
      </ty:Result>
    `;

			/*  Peaces to building my own query */

			var myQNameSpace = `
      import schema namespace ty="http://tethys.sdsu.edu/schema/1.0" at "tethys.xsd";
      import module namespace lib="http://tethys.sdsu.edu/XQueryFns" at "Tethys.xq";
    `;

			var myQResultOpenTag = `
      <ty:Result xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      {
      for $deployment in collection("Deployments")/ty:Deployment
    `;

			var myQWhereProject1 = `where $deployment/Project =`;


			var myQWhereSite1 = `where $deployment/Site =`;
			var myQWhereSiteNot1 = ` and $deployment/Site =`;


			var myQWhereCruise1 = `where $deployment/Cruise =`;
			var myQWhereCruiseNot1 = ` and $deployment/Cruise =`;

			var myQReturn = `return 
      <li> 
        {data($deployment)}
      <br />
      </li>
    `;

			var myQResultClosingTag = `
      }
      </ty:Result>`;




			$('#submit').on('click', function(e) {
				var i = 0;
				e.preventDefault();

				var project = $('#project').val();
				console.log("project: ", project);

				var site = $('#site').val();
				console.log("site: ", site);

				var cruise = $('#cruise').val();
				console.log("cruise: ", cruise);

				var fullQuery = "";



				fullQuery += myQNameSpace
				fullQuery += myQResultOpenTag;
				if (!isEmpty(project)) {
					fullQuery += myQWhereProject1 + ' "' + project + '" ';
					i++;
				}
				if (!isEmpty(site)) {
					if (i > 0)
						fullQuery += myQWhereSiteNot1 + ' "' + site + '" ';
					else {
						fullQuery += myQWhereSite1 + ' "' + site + '" ';
						i++;
					}
				}
				if (!isEmpty(cruise)) {
					if (i > 0)
						fullQuery += myQWhereCruiseNot1 + ' "' + cruise + '" ';
					else {
						fullQuery += myQWhereCruise1 + ' "' + cruise + '" ';
						i++
					}
				}

				fullQuery += myQReturn
				fullQuery += myQResultClosingTag;
				console.log(fullQuery);
				var data = {
					"XQuery": fullQuery
				};

				$.post(url, data, function(response) {
					console.log("response: ", response);
					$('#response').html(response);
				});



			});


			//true is something is empt or has '---' value
			function isEmpty(info) {
				info = info.trim();
				return (info.length == 0) || (info == '---')
			}






		}); // document Ready
		/* Set the width of the side navigation to 250px and the left margin of the page content to 250px */
		function openNav() {
			document.getElementById("mySidenav").style.width = "250px";
			document.getElementById("main").style.marginLeft = "250px";
		}

		/* Set the width of the side navigation to 0 and the left margin of the page content to 0 */
		function closeNav() {
			document.getElementById("mySidenav").style.width = "0";
			document.getElementById("main").style.marginLeft = "0";
		}

	</script>

</body>

</html>
